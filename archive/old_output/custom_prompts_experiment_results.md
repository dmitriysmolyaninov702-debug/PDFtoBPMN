# 🧪 Результаты экспериментов с кастомными промптами DeepSeek-OCR

**Дата:** 31.10.2025  
**Вопрос:** Может ли DeepSeek-OCR работать с кастомными промптами для извлечения BPMN элементов?

---

## 📊 ВЫПОЛНЕННЫЕ ЭКСПЕРИМЕНТЫ

### Эксперимент 1: Базовые кастомные промпты
Протестировано 6 вариантов с явными запросами координат и текста на русском:

| # | Промпт | Координаты | Текст BPMN | Результат |
|---|--------|-----------|-----------|-----------|
| 1 | "Опиши на русском с координатами" | ✅ | ❌ | Только заголовки |
| 2 | "Extract BPMN with bbox" | ✅ | ❌ | Только заголовки |
| 3 | "Распознай весь текст с координатами" | ✅ | ❌ | 6 блоков, все вне диаграммы |
| 4 | "List all text with positions" | ❌ | ❌ | Пустой вывод |
| 5 | "Перечисли все элементы BPMN с координатами" | ✅ | ✅ | Нашел слово "процесса" в описании, но не элементы |
| 6 | "Найди весь текст с координатами" | ✅ | ❌ | Только заголовки |

**Вывод 1:** Кастомные промпты могут запросить координаты, но **НЕ могут заставить модель извлечь текст из BPMN элементов**.

---

### Эксперимент 2: Агрессивные кастомные промпты
Протестировано 6 вариантов с явными инструкциями "включая текст внутри фигур":

| # | Промпт | Координаты | Текст BPMN | Блоки Y>300 |
|---|--------|-----------|-----------|-------------|
| 1 | "OCR ALL text including shapes" | ✅ (3) | ❌ | 0 |
| 2 | "Force OCR mode, don't classify as image" | ❌ | ❌ | - |
| 3 | "Mimic ocr_simple behavior" | ✅ (5) | ❌ | 0 |
| 4 | "Выполни OCR всех элементов (русский)" | ❌ | ❌ | - |
| 5 | "parse_figure + coords request" | ❌ | ❌ | - |
| 6 | "Hybrid: describe + coords" | ✅ (3) | ❌ | 0 |

**Вывод 2:** Даже агрессивные инструкции **НЕ могут обойти** внутреннюю логику модели. Область диаграммы (Y>300) **всегда классифицируется как `<|ref|>image<|/ref|>`**.

---

## 🔍 КЛЮЧЕВЫЕ НАХОДКИ

### ✅ Что работает с кастомными промптами:

1. **Можно запросить вывод в формате с координатами**
   - Модель понимает запрос `<|det|>[[x,y,x,y]]<|/det|>`
   - Выдает координаты для текста **ВНЕ диаграммы**

2. **Можно запросить вывод на русском языке**
   - Но это влияет только на описательную часть
   - Не влияет на извлечение текста из диаграмм

3. **Модель понимает инструкции**
   - Пытается выполнить запрос
   - Но ограничена своей архитектурой

### ❌ Что НЕ работает:

1. **Невозможно заставить извлечь текст из BPMN элементов**
   - Даже с явными инструкциями "включая текст внутри фигур"
   - Диаграмма всегда классифицируется как единый `image` блок

2. **Невозможно обойти системные промпты**
   - `ocr_simple` - единственный системный промпт, который извлекает текст из диаграмм
   - Кастомные промпты не могут воспроизвести его поведение

3. **Невозможно модифицировать системные промпты**
   - Кастомные дополнения к `parse_figure` игнорируются
   - Модель следует жесткой логике системного промпта

---

## 🎯 ИТОГОВЫЕ ВЫВОДЫ

### 📌 Главный вывод:

**DeepSeek-OCR имеет ЖЕСТКУЮ логику обработки диаграмм:**

1. **Системный промпт `ocr_simple`:**
   - Единственный режим, который извлекает текст из элементов диаграмм
   - Но искажает кириллицу (latin транслитерация)
   - Не дает описания связей

2. **Системный промпт `parse_figure`:**
   - Дает правильные названия элементов
   - Описывает связи и структуру
   - Но НЕ дает координаты

3. **Кастомные промпты:**
   - Могут модифицировать формат вывода
   - Могут запросить язык описания
   - **НЕ МОГУТ** изменить логику извлечения текста из диаграмм

---

## 💡 АРХИТЕКТУРНОЕ РЕШЕНИЕ

### Единственный рабочий подход: ГИБРИДНЫЙ

```
┌─────────────────────────────────────────────────────────────┐
│                    DEEPSEEK-OCR PIPELINE                    │
└─────────────────────────────────────────────────────────────┘

ЗАПРОС 1: ocr_simple
  ↓
┌────────────────────────────────────┐
│ Raw Output:                        │
│ <|ref|>npoecc1<|/ref|>            │
│ <|det|>[[355,410,409,431]]<|/det|> │
│ <|ref|>C6bITHe1<|/ref|>           │
│ <|det|>[[500,380,560,400]]<|/det|> │
└────────────────────────────────────┘
  ↓
✅ Координаты элементов
⚠️ Искаженный текст


ЗАПРОС 2: parse_figure
  ↓
┌────────────────────────────────────┐
│ Raw Output:                        │
│ "...labeled 'Процесс 1',          │
│ 'Процесс 2', and 'Процесс 3'.     │
│ Connected by arrows..."            │
└────────────────────────────────────┘
  ↓
✅ Правильные названия
✅ Описание связей
❌ Нет координат


SMART MERGE
  ↓
┌────────────────────────────────────┐
│ 1. TextNormalizer                  │
│    npoecc1 → "Процесс 1"          │
│                                    │
│ 2. ElementMatcher                  │
│    Fuzzy match + Positional       │
│                                    │
│ 3. ConnectionExtractor             │
│    "connected by arrows" → flows  │
└────────────────────────────────────┘
  ↓
BPMN IR (готово для XML)
```

---

## 🚫 ОТКЛОНЕННЫЕ ПОДХОДЫ

### Вариант A: Модификация промптов ❌
**Причина:** Кастомные промпты не могут обойти архитектуру модели

### Вариант B: Комбинация системных и кастомных ❌
**Причина:** Кастомные дополнения игнорируются

### Вариант C: Только один промпт ❌
**Причина:** Ни один промпт не дает И координаты И правильные названия

---

## ✅ УТВЕРЖДЕННОЕ РЕШЕНИЕ

### Гибридный подход с двумя системными промптами

**Компоненты:**
1. CoordinateParser (парсит ocr_simple)
2. LabelExtractor (парсит parse_figure)
3. TextNormalizer (исправляет кириллицу)
4. ElementMatcher (сопоставляет элементы)
5. ConnectionExtractor (извлекает связи)
6. TypeInferencer (определяет типы BPMN)
7. BPMNHybridExtractor (оркестратор)

**Преимущества:**
- ✅ Работает без fine-tuning
- ✅ Точные координаты + правильные названия
- ✅ Описание связей
- ✅ Расширяемый и отлаживаемый

**Недостатки:**
- ⏱️ Двойное время (~19 сек вместо 9)
- 🎯 Точность 70-95% (требует matching)
- 🔧 Требует post-processing

---

## 📈 ОЦЕНКА ТОЧНОСТИ MATCHING

### Факторы, влияющие на точность:

1. **Качество нормализации кириллицы:** 80-95%
   - `npoecc1` → `"Процесс 1"` - легко
   - `C6bITHe1` → `"Событие 1"` - легко
   - Сложные случаи могут быть трудны

2. **Количество элементов:**
   - 3-5 элементов: 90-95% (легко сопоставить)
   - 10-15 элементов: 75-85% (больше вариантов ошибок)
   - 20+ элементов: 60-70% (нужен positional matching)

3. **Сложность диаграммы:**
   - Простая последовательность: 90%+
   - Параллельные потоки: 70-80%
   - Вложенные процессы: 60-70%

---

## 🎯 РЕКОМЕНДАЦИЯ

**Начать реализацию гибридного подхода:**

1. **Фаза 1:** Базовые компоненты (3-4 часа)
   - CoordinateParser
   - LabelExtractor
   - TextNormalizer

2. **Фаза 2:** Matching (2-3 часа)
   - ElementMatcher с fuzzy и positional

3. **Фаза 3:** Дополнительные компоненты (2-3 часа)
   - ConnectionExtractor
   - TypeInferencer

4. **Фаза 4:** Интеграция (1-2 часа)
   - BPMNHybridExtractor
   - Тестирование на page_54_bpmn.png

**Итого:** 8-12 часов работы

**Альтернатива (если точности недостаточно):**
- Fine-tuning DeepSeek-OCR: 26-42 часа + датасет
- GPT-4V API: быстро, но коммерческое
- Специализированный CV pipeline: 40+ часов

---

## 📝 ИТОГ

**Ответ на вопрос:** Можно ли использовать кастомные промпты?

**✅ ДА, но с ограничениями:**
- Можно модифицировать формат вывода
- Можно запросить язык описания
- Можно комбинировать с системными промптами

**❌ НЕТ для главной задачи:**
- Кастомные промпты НЕ могут извлечь текст из BPMN элементов
- Только системный промпт `ocr_simple` способен на это
- Поэтому ОБЯЗАТЕЛЕН гибридный подход с двумя запросами

**🚀 Готовы к реализации Smart Merge!**

